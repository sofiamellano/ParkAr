<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AppMovil.Pages.ReservasPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:AppMovil.ViewModels"
    xmlns:models="clr-namespace:Service.Models;assembly=Service"
    xmlns:converters="clr-namespace:AppMovil.Converters"
    Title="{Binding Title}"
    x:DataType="viewmodels:ReservasPageViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Convertidor para invertir booleanos -->
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Button 
            Grid.Row="0"
            Text="+ Nueva Reserva"
            Command="{Binding CreateReservaCommand}"
            BackgroundColor="Blue"
            TextColor="White"
            CornerRadius="5"
            Margin="20,10" />

        <StackLayout Grid.Row="1" IsVisible="{Binding TieneReservas}">
            <CollectionView ItemsSource="{Binding Reservas}" Margin="20,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Reserva">
                        <Grid Padding="15" Margin="0,5">
                            <Frame BackgroundColor="White" 
                                   BorderColor="LightGray" 
                                   CornerRadius="10"
                                   HasShadow="True">
                                <StackLayout Spacing="10">
                                    <Label 
                                        Text="{Binding Lugar.Numero, StringFormat='Plaza {0}'}" 
                                        FontSize="16" 
                                        FontAttributes="Bold" />
                                    
                                    <StackLayout Orientation="Horizontal">
                                        <Label Text="Fecha:" FontSize="14" />
                                        <Label Text="{Binding FechaInicio, StringFormat='{0:dd/MM/yyyy}'}" FontSize="14" />
                                        <Label Text="Hora:" FontSize="14" />
                                        <Label Text="{Binding FechaInicio, StringFormat='{0:HH:mm}'}" FontSize="14" />
                                    </StackLayout>

                                    <StackLayout Orientation="Horizontal">
                                        <Label Text="Estado:" FontSize="12" />
                                        <Label Text="{Binding EstadoReserva}" FontSize="12" FontAttributes="Bold" />
                                    </StackLayout>

                                    <StackLayout Orientation="Horizontal" Spacing="10" Margin="0,10,0,0">
                                        <Button 
                                            Text="Ver Ticket" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ReservasPageViewModel}}, Path=ViewTicketCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Green"
                                            TextColor="White"
                                            FontSize="12"
                                            CornerRadius="5"
                                            HorizontalOptions="FillAndExpand" />
                                        
                                        <Button 
                                            Text="Modificar" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ReservasPageViewModel}}, Path=EditReservaCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Orange"
                                            TextColor="White"
                                            FontSize="12"
                                            CornerRadius="5"
                                            HorizontalOptions="FillAndExpand" />
                                        
                                        <Button 
                                            Text="Cancelar" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ReservasPageViewModel}}, Path=CancelReservaCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Red"
                                            TextColor="White"
                                            FontSize="12"
                                            CornerRadius="5"
                                            HorizontalOptions="FillAndExpand" />
                                    </StackLayout>
                                </StackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>

        <StackLayout Grid.Row="1" 
                     x:Name="EmptyStateLayout"
                     VerticalOptions="CenterAndExpand" 
                     HorizontalOptions="CenterAndExpand"
                     IsVisible="{Binding TieneReservas, Converter={StaticResource InvertedBoolConverter}}">
            <Label 
                Text="ðŸ…¿ï¸"
                FontSize="48"
                HorizontalOptions="Center" />
            <Label 
                Text="{Binding MensajeVacio}"
                FontSize="18"
                HorizontalOptions="Center"
                Margin="0,10" />
            <Label 
                Text="Presiona 'Nueva Reserva' para comenzar"
                FontSize="14"
                TextColor="Gray"
                HorizontalOptions="Center" />
        </StackLayout>
    </Grid>

</ContentPage>